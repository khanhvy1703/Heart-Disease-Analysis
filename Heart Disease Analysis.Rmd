---
title: "Heart Disease Analysis"
output: pdf_document
subtitle: "Maalolan Bharaniraj, Ngoc Khanh Vy Le, Madhuri Krishnamurthy, Subhankar Shah
"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!requireNamespace("tidyverse", quietly = TRUE)) {
  install.packages("tidyverse")
}
if (!requireNamespace("ggplot2", quietly = TRUE)) {
  install.packages("ggplot2")
}
if (!requireNamespace("dplyr", quietly = TRUE)) {
  install.packages("dplyr")
}
if (!requireNamespace("caret", quietly = TRUE)) {
  install.packages("caret")
}
if (!requireNamespace("pROC", quietly = TRUE)) {
  install.packages("pROC")
}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(caret)
library(pROC)
options(readr.show_col_types = FALSE)
```


## Import Dataset 1 - UCI
```{r}
hungarian <- read.csv("unprocessed-data-set/UCI/processed.cleveland.data")
switzerland <- read.csv("unprocessed-data-set/UCI/processed.va.data")
```

## Import Dataset 2 - CDC 
```{r}
heart_2016_2018 <- read.csv("unprocessed-data-set/CDC/Heart_Disease_Mortality_Data_Among_US_Adults_2016-2018.csv")

heart_2019_2021 <- read.csv("unprocessed-data-set/CDC/Heart_Disease_Mortality_Data_Among_US_Adults_2019-2021.csv")

stoke_2019_2021 <- read.csv("unprocessed-data-set/CDC/Stroke_Mortality_Data_Among_US_Adults_2019-2021.csv")
```

## Import Dataset 3 - Kaggle
```{r}
heart_2022 <- read.csv("unprocessed-data-set/Kaggle/heart_2022_no_nans.csv")
```


## Cleaning UCI data set
```{r}
# tidy data
dataLists <- list(hungarian, switzerland)
columnNames <- c("age", "sex", "cp", "trestbps", "chol", "fbs", "restecg", 
                 "thalach", "exang", "oldpeak", "slope", "ca", "thal",
                 "have_heart_disease")

# Rename function
renameColumns <- function(df) {
  names(df) <- columnNames
  return(df)
}

hungarian <- renameColumns(hungarian)
switzerland <- renameColumns(switzerland)

# merge all  data frame into 1
uci <- rbind(hungarian, switzerland)

uci <- data.frame(uci)

# convert "?" into N/A
for (col_name in names(uci)) {
  uci[[col_name]][uci[[col_name]] == "?"] <- NA
}

uci <- uci %>%
  mutate(sex = case_when(sex == 0 ~ "female",
                         sex == 1 ~ "males")) %>%
  mutate(cp = case_when(cp == 1 ~ "typical angina",
                        cp == 2 ~ "atypical angina",
                        cp == 3 ~"non-anginal pain",
                        cp == 4 ~"asymptomatic")) %>%
  mutate(fbs = case_when(fbs == "0" ~ "true",
                         fbs == "1" ~ "false")) %>%
  mutate(restecg = case_when(restecg == 0 ~ "normal",
                             restecg == 1 ~ "ST-T wave abnormality",
                             restecg == 2 ~ "left ventricular hypertrophy")) %>%
  mutate(exang = case_when(exang == 0 ~ "no",
                           exang == 1 ~ "yes")) %>%
  mutate(slope = case_when(slope == "1" ~ "upsloping",
                           slope == "2" ~ "flat",
                           slope == "3" ~ "downsloping")) %>%
  mutate(thal = case_when(thal %in% c("3.0") ~ "normal",
                          thal %in% c("6.0") ~ "fixed defect",
                          thal %in% c("7.0", "7") ~ "reversable defect")) %>%
  mutate(have_heart_disease = case_when(have_heart_disease == 0 ~ "no",
                                        have_heart_disease %in% c(1, 2, 3, 4) ~ 
                                          "yes"))
# mutate to numeric 
uci$trestbps <- as.numeric(uci$trestbps)
uci$chol <- as.numeric(uci$chol)
uci$thalach <- as.numeric(uci$thalach)
uci$oldpeak <- as.numeric(uci$oldpeak)
uci$ca <- as.numeric(uci$ca)

# filter the NA values
for (col in names(uci)) {
  if (is.numeric(uci[[col]])) {
    mean_val <- round(mean(uci[[col]], na.rm = TRUE))
    uci[[col]][is.na(uci[[col]])] <- mean_val
  } else {
    mode_val <- names(sort(table(uci[[col]]), decreasing = TRUE))[1]
    uci[[col]][is.na(uci[[col]])] <- mode_val
  }
}

# get unique values
uniqueValues <- sapply(uci, unique)
```

## cleaning CDC data set
```{r}
drops <- c("Georeference")
heart_2019_2021 <- heart_2019_2021[ , !(names(heart_2019_2021) %in% drops)]

cdc <- rbind(heart_2016_2018, heart_2019_2021)
cdc <- data.frame(cdc)

# drop unnecessary columns
drops <- c("Year", "X_lon", "Y_lat", "Class", "DataSource", 
           "Data_Value_Footnote_Symbol", "Data_Value_Footnote",
           "StratificationCategory1", "StratificationCategory2",
           "Data_Value_Unit")
cdc <- cdc[ , !(names(cdc) %in% drops)]

# rename
colnames(cdc)[colnames(cdc) == "Data_Value"] <- "Data_Value_Per_100000_Population"

for (col in names(cdc)) {
  if (is.numeric(cdc[[col]])) {
    mean_val <- round(mean(cdc[[col]], na.rm = TRUE), 2)
    cdc[[col]][is.na(cdc[[col]])] <- mean_val
  } else {
    mode_val <- names(sort(table(cdc[[col]]), decreasing = TRUE))[1]
    cdc[[col]][is.na(cdc[[col]])] <- mode_val
  }
}
```


## cleaning Kaggle data set
```{r}
# drop unnecessary columns
drops <- c("PhysicalHealthDays", "MentalHealthDays", "LastCheckupTime", 
           "RemovedTeeth", "ChestScan", 
           "TetanusLast10Tdap", "HighRiskLastYear",
           "StratificationCategory1", "StratificationCategory2",
           "Data_Value_Unit")
heart_2022 <- heart_2022[ , !(names(heart_2022) %in% drops)]
```

## Feature Engineering

### Binning Age and BMI:

Creating bins for BMI, sleep category to simplify the patterns for the machine learning algorithm.
```{r}
# Binning BMI
bmi_bins <- c(0, 18.5, 25, 30, Inf)
bmi_labels <- c("Underweight", "Normal", "Overweight", "Obese")
heart_2022$BMICategory <- cut(heart_2022$BMI, bmi_bins, 
                               labels = bmi_labels, right = FALSE)


# Define bins and labels for sleep duration categories
sleep_bins <- c(0, 5, 7, 9, Inf)  
sleep_labels <- c("Less than 5 hours", "5-7 hours", 
                  "7-9 hours", "More than 9 hours")

# Create a new categorical variable for sleep duration
heart_2022$SleepCategory <- cut(heart_2022$SleepHours, sleep_bins, 
                                labels = sleep_labels, right = FALSE)
```

### Scaling Numerical Variables:

Scaling can help improve the performance of algorithms like SVM or KNN. You can use scale() for this purpose.
```{r}
heart_2022$ScaledHeight <- scale(heart_2022$HeightInMeters)
heart_2022$ScaledWeight <- scale(heart_2022$WeightInKilograms)
```

### Feature Combination:

Creating new features based on existing ones. Creating a binary variable indicating whether a person has any pre-existing conditions.
```{r}
heart_2022$HasConditions <- ifelse(heart_2022$HadHeartAttack == 'Yes' | 
                                     heart_2022$HadAngina == 'Yes' | 
                                     heart_2022$HadStroke == 'Yes' | 
                                     heart_2022$HadAsthma == 'Yes' | 
                                     heart_2022$HadSkinCancer == 'Yes' | 
                                     heart_2022$HadCOPD == 'Yes' | 
                                     heart_2022$HadCOPD == 'Yes' |
                                     heart_2022$HadDepressiveDisorder == 'Yes' |
                                     heart_2022$HadKidneyDisease == 'Yes' |
                                     heart_2022$HadArthritis == 'Yes' |
                                     heart_2022$HadDiabetes == 'Yes', 'Yes','No')

heart_2022$Vaccinated <- ifelse(heart_2022$FluVaxLast12 == 'Yes' | 
                                  heart_2022$PneumoVaxEver == 'Yes', 'Yes','No')


drops <- c("FluVaxLast12", "PneumoVaxEver")
heart_2022 <- heart_2022[ , !(names(heart_2022) %in% drops)]
```

## Feature Engineering for UCI data
```{r}
# Age Binning
uci <- uci %>%
  mutate(age_group = case_when(
    age < 40 ~ "Young",
    age >= 40 & age < 60 ~ "Middle-aged",
    age >= 60 ~ "Elderly"
  ))

# Blood Pressure Scaling (Min-Max scaling)
uci$bps_scaled <- scale(uci$trestbps, center = FALSE, 
                               scale = max(uci$trestbps))

# Cholesterol Binning
uci <- uci %>%
  mutate(cholesterol_group = case_when(
    chol < 200 ~ "Normal",
    chol >= 200 & chol < 240 ~ "Borderline High",
    chol >= 240 ~ "High"
  ))

# Encoding Categorical Variables
uci <- uci %>%
  mutate(
    sex = as.factor(sex),
    fbs = as.factor(fbs),
    restecg = as.factor(restecg),
    thalach = as.factor(thalach)
  )

# One-hot encoding
one_hot_uci <- dummyVars(~ sex + fbs + restecg + thalach, data = uci) %>%
  predict(uci)
```

## Insight
Identify the region
```{r}
regions <- c(
  CT = 'Northeast', ME = 'Northeast', MA = 'Northeast', NH = 'Northeast',
  RI = 'Northeast', VT = 'Northeast', NJ = 'Northeast', NY = 'Northeast',
  PA = 'Northeast', IL = 'Midwest', IN = 'Midwest', MI = 'Midwest',
  OH = 'Midwest', WI = 'Midwest', IA = 'Midwest', KS = 'Midwest',
  MN = 'Midwest', MO = 'Midwest', NE = 'Midwest', ND = 'Midwest',
  SD = 'Midwest', DE = 'South', FL = 'South', GA = 'South',
  MD = 'South', NC = 'South', SC = 'South', VA = 'South',
  DC = 'South', WV = 'South', AL = 'South', KY = 'South',
  MS = 'South', TN = 'South', AR = 'South', LA = 'South',
  OK = 'South', TX = 'South', AZ = 'West', CO = 'West',
  ID = 'West', MT = 'West', NV = 'West', NM = 'West',
  UT = 'West', WY = 'West', AK = 'West', CA = 'West',
  HI = 'West', OR = 'West', WA = 'West'
)

cdc <- cdc %>%
  mutate(Region = regions[LocationAbbr])

cdc <- na.omit(cdc)

heart_disease_by_regions <- cdc %>%
  group_by(Region) %>%
  summarise(Total_Heart_Disease = sum(Data_Value_Per_100000_Population))

ggplot(heart_disease_by_regions, aes(x = Region, 
                                     y = Total_Heart_Disease, 
                                     fill = Region)) +
  geom_bar(stat = "identity", color = "black") +
  theme_minimal() +
  labs(title = "Total Heart Disease Cases by Region",
       x = "Region",
       y = "Total Cases per 100,000 Population")

head(cdc)
```
The South region shows a significantly higher number of cases compared to the Midwest, Northeast, and West. The South is known for a culinary tradition that often includes fried foods, higher consumption of red meat, and sweetened beverages, which can contribute to higher rates of obesity, hypertension, and diabetes - all risk factors for heart disease. 

```{r}
# Encode categorical variables
uci$sex <- as.numeric(factor(uci$sex))
uci$cp <- as.numeric(factor(uci$cp))
uci$fbs <- as.numeric(factor(uci$fbs))
uci$restecg <- as.numeric(factor(uci$restecg))
uci$exang <- as.numeric(factor(uci$exang))
uci$slope <- as.numeric(factor(uci$slope))
uci$thal <- as.numeric(factor(uci$thal))
uci$have_heart_disease <- as.factor(uci$have_heart_disease)

# Combining rare levels
level_counts <- table(uci$thalach)
rare_levels <- names(level_counts[level_counts < 5])

# Replace rare levels with a common category
uci$thalach <- as.character(uci$thalach)
uci$thalach[uci$thalach %in% rare_levels] <- "Other"
uci$thalach <- factor(uci$thalach)


# Split data into training and test sets
set.seed(123) # for reproducibility
indexes <- createDataPartition(uci$have_heart_disease, p=0.8, list=FALSE)
train <- uci[indexes,]
test <- uci[-indexes,]

train$thalach <- factor(train$thalach, levels = levels(uci$thalach))
test$thalach <- factor(test$thalach, levels = levels(uci$thalach))

# Fit the logistic regression model
model <- glm(have_heart_disease ~ ., data = train, family = binomial())

# Summarize the model
summary(model)

predictions <- predict(model, test, type="response")
predicted_classes <- ifelse(predictions > 0.5, "yes", "no")
predicted_classes <- factor(predicted_classes, levels = c("no", "yes"))

# Confusion matrix to see the accuracy, sensitivity, and specificity
confusionMatrix(predicted_classes, test$have_heart_disease)

# ROC curve
roc_response <- roc(response = test$have_heart_disease, predictor = as.numeric(predictions))
plot(roc_response)
auc(roc_response)
```
```{r}
str(cdc)
# get unique values
uniqueValues <- sapply(cdc, unique)
uniqueValues

# Convert Region to a factor if it's not already
cdc$Region <- as.factor(cdc$Region)

# Run linear regression model
model <- lm(Data_Value_Per_100000_Population ~ Region, data = cdc)

# Summary of the model
summary(model)

# Plotting the relationship
ggplot(cdc, aes(x = Region, y = Data_Value_Per_100000_Population)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.3, color = "tomato") +
  labs(y = "Heart Disease Mortality Rate per 100,000 Population",
       x = "Region",
       title = "Heart Disease Mortality Rate by Region")

# Diagnostic plots
par(mfrow = c(2,2))
plot(model)
```