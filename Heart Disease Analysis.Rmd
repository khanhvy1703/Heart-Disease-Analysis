---
title: "Heart Disease Analysis"
output: pdf_document
subtitle: "Maalolan Bharaniraj, Ngoc Khanh Vy Le, Madhuri Krishnamurthy, Subhankar Shah
"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!requireNamespace("tidyverse", quietly = TRUE)) {
  install.packages("tidyverse")
}
if (!requireNamespace("ggplot2", quietly = TRUE)) {
  install.packages("ggplot2")
}
if (!requireNamespace("dplyr", quietly = TRUE)) {
  install.packages("dplyr")
}
if (!requireNamespace("caret", quietly = TRUE)) {
  install.packages("caret")
}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(caret)
options(readr.show_col_types = FALSE)
```


## Import Dataset 1 - UCI
```{r}
hungarian <- read.csv("unprocessed-data-set/UCI/hungarian.data")
switzerland <- read.csv("unprocessed-data-set/UCI/switzerland.data")
```

## Import Dataset 2 - CDC 
```{r}
heart_2016_2018 <- read.csv("unprocessed-data-set/CDC/Heart_Disease_Mortality_Data_Among_US_Adults_2016-2018.csv")

heart_2019_2021 <- read.csv("unprocessed-data-set/CDC/Heart_Disease_Mortality_Data_Among_US_Adults_2019-2021.csv")

stoke_2019_2021 <- read.csv("unprocessed-data-set/CDC/Stroke_Mortality_Data_Among_US_Adults_2019-2021.csv")
```

## Import Dataset 3 - Kaggle
```{r}
heart_2022 <- read.csv("unprocessed-data-set/Kaggle/heart_2022_no_nans.csv")
```


## Cleaning UCI data set
```{r}
# tidy data
dataLists <- list(hungarian, switzerland)
columnNames <- c("age", "sex", "cp", "trestbps", "chol", "fbs", "restecg", 
                 "thalach", "exang", "oldpeak", "slope", "ca", "thal",
                 "have_heart_disease")

# Rename function
renameColumns <- function(df) {
  names(df) <- columnNames
  return(df)
}

hungarian <- renameColumns(hungarian)
switzerland <- renameColumns(switzerland)

# merge all  data frame into 1
uci <- rbind(hungarian, switzerland)

uci <- data.frame(uci)

# convert "?" into N/A and then remove N/A values
for (col_name in names(uci)) {
  uci[[col_name]][uci[[col_name]] == "?"] <- NA
}

uci <- uci %>%
  mutate(sex = case_when(sex == 0 ~ "female",
                         sex == 1 ~ "males")) %>%
  mutate(cp = case_when(cp == 1 ~ "typical angina",
                        cp == 2 ~ "atypical angina",
                        cp == 3 ~"non-anginal pain",
                        cp == 4 ~"asymptomatic")) %>%
  mutate(fbs = case_when(fbs == "0" ~ "true",
                         fbs == "1" ~ "false")) %>%
  mutate(restecg = case_when(restecg == 0 ~ "normal",
                             restecg == 1 ~ "ST-T wave abnormality",
                             restecg == 2 ~ "left ventricular hypertrophy")) %>%
  mutate(exang = case_when(exang == 0 ~ "no",
                           exang == 1 ~ "yes")) %>%
  mutate(slope = case_when(slope == "1" ~ "upsloping",
                           slope == "2" ~ "flat",
                           slope == "3" ~ "downsloping")) %>%
  mutate(thal = case_when(thal %in% c("3.0") ~ "normal",
                          thal %in% c("6.0") ~ "fixed defect",
                          thal %in% c("7.0", "7") ~ "reversable defect")) %>%
  mutate(have_heart_disease = case_when(have_heart_disease == 0 ~ "no",
                                        have_heart_disease %in% c(1, 2, 3, 4) ~ 
                                          "yes"))
# mutate to numeric 
uci$trestbps <- as.numeric(uci$trestbps)
uci$chol <- as.numeric(uci$chol)
uci$thalach <- as.numeric(uci$thalach)
uci$oldpeak <- as.numeric(uci$oldpeak)
uci$ca <- as.numeric(uci$ca)

# filter the NA values
for (col in names(uci)) {
  if (is.numeric(uci[[col]])) {
    mean_val <- round(mean(uci[[col]], na.rm = TRUE))
    uci[[col]][is.na(uci[[col]])] <- mean_val
  } else {
    mode_val <- names(sort(table(uci[[col]]), decreasing = TRUE))[1]
    uci[[col]][is.na(uci[[col]])] <- mode_val
  }
}

# get unique values
uniqueValues <- sapply(uci, unique)
```

## cleaning CDC data set
```{r}
drops <- c("Georeference")
heart_2019_2021 <- heart_2019_2021[ , !(names(heart_2019_2021) %in% drops)]

cdc <- rbind(heart_2016_2018, heart_2019_2021)
cdc <- data.frame(cdc)

# drop unnecessary columns
drops <- c("Year", "X_lon", "Y_lat", "Class", "DataSource", 
           "Data_Value_Footnote_Symbol", "Data_Value_Footnote",
           "StratificationCategory1", "StratificationCategory2",
           "Data_Value_Unit")
cdc <- cdc[ , !(names(cdc) %in% drops)]

# rename
colnames(cdc)[colnames(cdc) == "Data_Value"] <- "Data_Value_Per_100000_Population"

for (col in names(cdc)) {
  if (is.numeric(cdc[[col]])) {
    mean_val <- round(mean(cdc[[col]], na.rm = TRUE), 2)
    cdc[[col]][is.na(cdc[[col]])] <- mean_val
  } else {
    mode_val <- names(sort(table(cdc[[col]]), decreasing = TRUE))[1]
    cdc[[col]][is.na(cdc[[col]])] <- mode_val
  }
}
```


## cleaning Kaggle data set
```{r}
# drop unnecessary columns
drops <- c("PhysicalHealthDays", "MentalHealthDays", "LastCheckupTime", 
           "RemovedTeeth", "ChestScan", 
           "TetanusLast10Tdap", "HighRiskLastYear",
           "StratificationCategory1", "StratificationCategory2",
           "Data_Value_Unit")
heart_2022 <- heart_2022[ , !(names(heart_2022) %in% drops)]
```

## Feature Engineering

### Binning Age and BMI:

Creating bins for BMI, sleep category to simplify the patterns for the machine learning algorithm.
```{r}
# Binning BMI
bmi_bins <- c(0, 18.5, 25, 30, Inf)
bmi_labels <- c("Underweight", "Normal", "Overweight", "Obese")
heart_2022$BMICategory <- cut(heart_2022$BMI, bmi_bins, 
                               labels = bmi_labels, right = FALSE)


# Define bins and labels for sleep duration categories
sleep_bins <- c(0, 5, 7, 9, Inf)  
sleep_labels <- c("Less than 5 hours", "5-7 hours", 
                  "7-9 hours", "More than 9 hours")

# Create a new categorical variable for sleep duration
heart_2022$SleepCategory <- cut(heart_2022$SleepHours, sleep_bins, 
                                labels = sleep_labels, right = FALSE)
```

### Scaling Numerical Variables:

Scaling can help improve the performance of algorithms like SVM or KNN. You can use scale() for this purpose.
```{r}
heart_2022$ScaledHeight <- scale(heart_2022$HeightInMeters)
heart_2022$ScaledWeight <- scale(heart_2022$WeightInKilograms)
```

### Feature Combination:

Creating new features based on existing ones. Creating a binary variable indicating whether a person has any pre-existing conditions.
```{r}
heart_2022$HasConditions <- ifelse(heart_2022$HadHeartAttack == 'Yes' | 
                                     heart_2022$HadAngina == 'Yes' | 
                                     heart_2022$HadStroke == 'Yes' | 
                                     heart_2022$HadAsthma == 'Yes' | 
                                     heart_2022$HadSkinCancer == 'Yes' | 
                                     heart_2022$HadCOPD == 'Yes' | 
                                     heart_2022$HadCOPD == 'Yes' |
                                     heart_2022$HadDepressiveDisorder == 'Yes' |
                                     heart_2022$HadKidneyDisease == 'Yes' |
                                     heart_2022$HadArthritis == 'Yes' |
                                     heart_2022$HadDiabetes == 'Yes', 'Yes','No')

heart_2022$Vaccinated <- ifelse(heart_2022$FluVaxLast12 == 'Yes' | 
                                  heart_2022$PneumoVaxEver == 'Yes', 'Yes','No')


drops <- c("FluVaxLast12", "PneumoVaxEver")
heart_2022 <- heart_2022[ , !(names(heart_2022) %in% drops)]
```

## Feature Engineering for UCI data
```{r}
# Age Binning
uci <- uci %>%
  mutate(age_group = case_when(
    age < 40 ~ "Young",
    age >= 40 & age < 60 ~ "Middle-aged",
    age >= 60 ~ "Elderly"
  ))

# Blood Pressure Scaling (Min-Max scaling)
uci$bps_scaled <- scale(uci$trestbps, center = FALSE, 
                               scale = max(uci$trestbps))

# Cholesterol Binning
uci <- uci %>%
  mutate(cholesterol_group = case_when(
    chol < 200 ~ "Normal",
    chol >= 200 & chol < 240 ~ "Borderline High",
    chol >= 240 ~ "High"
  ))

# Encoding Categorical Variables
uci <- uci %>%
  mutate(
    sex = as.factor(sex),
    fbs = as.factor(fbs),
    restecg = as.factor(restecg),
    thalach = as.factor(thalach)
  )

# One-hot encoding
one_hot_uci <- dummyVars(~ sex + fbs + restecg + thalach, data = uci) %>%
  predict(uci)
```

